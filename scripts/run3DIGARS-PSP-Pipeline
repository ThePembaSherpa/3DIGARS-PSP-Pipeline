#!/bin/sh
#purpose: run 3DIGARS-PSP Pipeline 
#author: Avdesh Mishra

protein_id="T0859"
input_path="../$protein_id/"
fasta_path="../$protein_id/$protein_id.fasta"

itasser_unicon_path="../AdditionalCodes/"
three_DIGARS_PSP_path="../3DIGARS-PSP"
three_DIGARS_PSP_code_path="../3DIGARS-PSP/codes/"
qprob_path="/home/amishra2/Ab-Initio-CASP13/structure_ranking/qprob_package"
three_DIGARS_PSP_Output_Parser="../AdditionalCodes/"
modrefiner_path="../../../Ab-Initio-CASP13/refinement_tool/ModRefiner-l/"
resq_input_path="../../../Ab-Initio-Softs/I-TASSER5.1/ResQ/CASP13/"
insert_bfactor_path="./Insert-BFactors-InPredStructure/"
insert_bfactor_code_path="./Insert-BFactors-InPredStructure/code/"
num_unicon_decoys=1000

#export LD_LIBRARY_PATH=/home/amishra2/Ab-Initio/ExistingAbInitioPrograms/Unicon3D-LowTMscoreModels_CASP8

# Note:: Please note that this script calles multiple programs which are installed in a differnt location. Thus, the programs called by this script file contains some paths
		# which might needs to be changed. Please open individual *.cpp files inside "../AdditionalCodes/" directory to fix the paths.


#******************************************************* Run PSSM ********************************************************************************************************
if [ -f ./log_3DIGARS-PSP-Pipeline.txt ]
then
	rm ./log_3DIGARS-PSP-Pipeline.txt
fi
#echo "Running PSSM" >> log_3DIGARS-PSP-Pipeline.txt
./runPSSM $protein_id $input_path $fasta_path
#echo "Running PSSM done" >> log_3DIGARS-PSP-Pipeline.txt

#******************************************************* Run I-TASSER and UniCon3D ***************************************************************************
	# Runs I-TASSER, UniCon3D, Qprob, MUFoldClustering and "GetFiveModelsByParsingQprobAndMuFold" programs ... finally generates a file containing top models from UniCon3D

#echo "Running I-TASSER, UniCon3D, Qprob, MUFoldClustering and "GetFiveModelsByParsingQprobAndMuFold programs" >> log_3DIGARS-PSP-Pipeline.txt
#cd $itasser_unicon_path
#mpiCC RunITasserAndUnicon3D.cpp -o RunITasserAndUnicon3D.exe -lm
#mpirun -np 2 ./RunITasserAndUnicon3D.exe $protein_id $num_unicon_decoys
#echo "Running I-TASSER, UniCon3D, Qprob, MUFoldClustering and "GetFiveModelsByParsingQprobAndMuFold programs done" >> ../log_3DIGARS-PSP-Pipeline.txt


#******************************************************* Run ModRefiner to refine top models obtained from UniCon3D ***************************************************************************
	# remove already existing models from the refinement program
#echo "Running ModRefiner to refine top models from UniCon3D" >> ../log_3DIGARS-PSP-Pipeline.txt
#if [ -d $modrefiner_path$protein_id ] 
#then
#	rm -r $modrefiner_path$protein_id
#fi
#mkdir $modrefiner_path$protein_id

	# parser the output file generated by "GetFiveModelsByParsingQprobAndMuFold" to obtain the number of process needed to run ModRefiner program as well as copy these models to ModRefiner program

#i=0;
#for line in `cat ./$protein_id.unicon_top_five`
#do
#	cp ./$line $modrefiner_path$protein_id/
#	i=$((i+1))
#done
	#echo $i

	# run ModRefiner program
#mpirun -np $i ./runModRefiner.exe ./$protein_id.unicon_top_five $protein_id

	# copy top unicon3D models to the 3DIGARS-PSP input directory
#if [ -d $three_DIGARS_PSP_path/input/seeds/input/ ]
#then
#	rm -r $three_DIGARS_PSP_path/input/seeds/input/ # remove the directory to get rid of any previous models
#	mkdir $three_DIGARS_PSP_path/input/seeds/input/ # create the directory again to copy the new models inside it
#fi
#cp $modrefiner_path$protein_id/em*.pdb $three_DIGARS_PSP_path/input/seeds/input/
#echo "Running ModRefiner to refine top models from UniCon3D done" >> ../log_3DIGARS-PSP-Pipeline.txt

#******************************************************* Run 3DIGARS-PSP ***************************************************************************
#echo "Running 3DIGARS-PSP" >> ../log_3DIGARS-PSP-Pipeline.txt
#cp ../$protein_id/$protein_id.fasta $three_DIGARS_PSP_path/input/fasta/
#truncate $three_DIGARS_PSP_path/input/pdbList.txt --size 0
#echo "$protein_id" >> $three_DIGARS_PSP_path/input/pdbList.txt
#cp ../$protein_id/$protein_id.mat $three_DIGARS_PSP_path/pssmout/
#cd $three_DIGARS_PSP_code_path
#mpiCC *.cpp -o main.exe -lm
#mpirun -np 4 ./main.exe > console_$protein_id.txt
#echo "Running 3DIGARS-PSP done" >> ../../scripts/log_3DIGARS-PSP-Pipeline.txt

#******************************************************* Run 3DIGARS-PSP Output Parser ***************************************************************************
	# this program first runs 3DIGARS-PSP output parser program next it runs Qprob program for structure ranking. Then it runs MuFold clustering program and subsequently runs GetFiveModelsByParsingQprobAndMuFold program.
#echo "Running 3DIGARS-PSP Output Parser" >> ../../scripts/log_3DIGARS-PSP-Pipeline.txt
	#cd ../$three_DIGARS_PSP_Output_Parser # turn on this line if you start from the beginning
cd $three_DIGARS_PSP_Output_Parser # turn on this line if you are starting from "3DIGARS-PSP output parser" .. i.e. from this code segment
mpiCC prepare3DIGARS-PSPOutput.cpp -o prepare3DIGARS-PSPOutput.exe -lm
mpirun -np 1 ./prepare3DIGARS-PSPOutput.exe $protein_id
#echo "Running 3DIGARS-PSP Output Parser done" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt

#******************************************************* Run ModRefiner to refine top models obtained from 3DIGARS-PSP ***************************************************************************
	# remove already existing models from the refinement program
#echo "Running ModRefiner to refine top models obtained from 3DIGARS-PSP" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt
if [ -d $modrefiner_path$protein_id ] 
then
	rm -r $modrefiner_path$protein_id
fi
mkdir $modrefiner_path$protein_id

	# parser the output file generated by "GetFiveModelsByParsingQprobAndMuFold" to obtain the number of process needed to run ModRefiner program as well as copy these models to ModRefiner program

i=0;
for line in `cat ./$protein_id.3DIGARS_top_five`
do
	cp ../output/$protein_id/$line $modrefiner_path$protein_id/
	i=$((i+1))
done
	#echo $i

	# run ModRefiner program
mpirun -np $i ./runModRefiner.exe ./$protein_id.3DIGARS_top_five $protein_id
#echo "Running ModRefiner to refine top models obtained from 3DIGARS-PSP done" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt


#******************************************************* Run ResQ ***************************************************************************
#echo "Running ResQ" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt
i=0;
for line in `cat ./$protein_id.3DIGARS_top_five`
do
	i=$((i+1))
	if [ -d $resq_input_path$protein_id-m$i ] 
	then
		rm -r $resq_input_path$protein_id-m$i
	fi
	mkdir $resq_input_path$protein_id-m$i
	model_name=em$line
	cp $modrefiner_path$protein_id/$model_name $resq_input_path$protein_id-m$i/
done

	# run ResQ program
mpirun -np $i ./runResQ.exe ./$protein_id.3DIGARS_top_five $protein_id
#echo "Running ResQ done" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt

#******************************************************* Run Program to insert beta factor in final models *************************************
	# create a dir name pdb_id inside "insert_bfactor" program dir
#echo "Running insert_bfactor program" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt
if [ -d $insert_bfactor_path$protein_id ] 
then
	rm -r $insert_bfactor_path$protein_id
fi
mkdir $insert_bfactor_path$protein_id

	# create dir for each model file inside "insert_bfactor" program dir ... then copy the refined model files ... then copy resq output ...  
i=0;
for line in `cat ./$protein_id.3DIGARS_top_five`
do
	i=$((i+1))
	mkdir $insert_bfactor_path$protein_id/$protein_id-m$i
	model_name=em$line
	cp $modrefiner_path$protein_id/$model_name $insert_bfactor_path$protein_id/$protein_id-m$i/ # copy the refined final model
	cp $resq_input_path$protein_id-m$i/local.txt $insert_bfactor_path$protein_id/$protein_id-m$i/ # copy the ResQ output file
done

	# Run insert_bfactor program

cd $insert_bfactor_code_path
./main.exe $protein_id

	# Copy the final prediction models to the output directory
cd ../../
i=0;
for line in `cat ./$protein_id.3DIGARS_top_five`
do
	i=$((i+1))
	cp $insert_bfactor_path$protein_id/$protein_id-m$i/$protein_id'_Model'$i.pdb ../output/ # copy the ResQ output file
done
#echo "Running insert_bfactor program done" >> ../scripts/log_3DIGARS-PSP-Pipeline.txt
